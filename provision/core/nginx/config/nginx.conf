# nginx.conf
#
# This is *the* config file for nginx in the virtual machine, and it
# should probably not be altered often as most things are already
# setup. If you do find yourself altering something here, you may want
# to consider discussing it at the repo so we can share in your findings

# User to run nginx as
user    www-data;

# Default to number of CPU cores available
worker_processes  auto;

# Default error log file
error_log   /var/log/nginx/error.log;

# Nginx process identifier
pid     /var/run/nginx.pid;

# The EventsModule controls how Nginx deals with connections
events {
    # max clients = worker_processes (CPUs) * worker_connections
    worker_connections  2000;
}

# The HttpCoreModule controls core features of Nginx's HTTP processing
http {

    # Define MIME types for files
    include      /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Default log file
    access_log  /var/log/nginx/access.log;

    map $status $status_text {
        400 'Bad Request';
        401 'Unauthorized';
        402 'Payment Required';
        403 'Forbidden';
        404 'Not Found';
        405 'Method Not Allowed';
        406 'Not Acceptable';
        407 'Proxy Authentication Required';
        408 'Request Timeout';
        409 'Conflict';
        410 'Gone';
        411 'Length Required';
        412 'Precondition Failed';
        413 'Payload Too Large';
        414 'URI Too Long';
        415 'Unsupported Media Type';
        416 'Range Not Satisfiable';
        417 'Expectation Failed';
        418 'I\'m a teapot';
        421 'Misdirected Request';
        422 'Unprocessable Entity';
        423 'Locked';
        424 'Failed Dependency';
        425 'Too Early';
        426 'Upgrade Required';
        428 'Precondition Required';
        429 'Too Many Requests';
        431 'Request Header Fields Too Large';
        451 'Unavailable For Legal Reasons';
        500 'Internal Server Error';
        501 'Not Implemented';
        502 'Bad Gateway';
        503 'Service Unavailable';
        504 'Gateway Timeout';
        505 'HTTP Version Not Supported';
        506 'Variant Also Negotiates';
        507 'Insufficient Storage';
        508 'Loop Detected';
        510 'Not Extended';
        511 'Network Authentication Required';
        default 'Something is wrong';
    }

    error_page 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 421 422 423 424 425 426 428 429 431 451 500 501 502 503 504 505 506 507 508 510 511 /error.html;

    # Turn sendfile off in a virtual machine because of issues
    #
    # The nginx default for sendfile is on, which appears to not jive with something
    # about the VM for some things, causing weird encoding issues in Javascript
    # that create syntax errors and weird encoding issues in CSS that make it seem
    # like your file has been cached forever. Crazy stuff - so off it is.
    #
    # See - http://jeremyfelt.com/code/2013/01/08/clear-nginx-cache-in-vagrant/
    #
    # Note that this should most likely be turned on in a production environment
    sendfile            off;

    # Don't send out partial TCP frames
    tcp_nopush          on;

    # How long each connection should stay idle
    keepalive_timeout   5;

    # Hide nginx version information
    server_tokens       off;

    # Enable Gzip compression
    gzip          on;

    # Compression level (1-9)
    gzip_comp_level     5;

    # Don't compress anything under 256 bytes
    gzip_min_length     256;

    # Compress output of these MIME-types
    gzip_types
        application/atom+xml
        application/javascript
        application/json
        application/rss+xml
        application/vnd.ms-fontobject
        application/x-font-ttf
        application/x-javascript
        application/x-web-app-manifest+json
        application/xhtml+xml
        application/xml
        font/opentype
        image/svg+xml
        image/x-icon
        text/css
        text/plain
        text/x-component;

    # Disable gzip for bad browsers
    gzip_disable  "MSIE [1-6]\.(?!.*SV1)";

    # Upstream to abstract backend connection(s) for PHP.
    upstream php {
        server unix:/var/run/php7.4-fpm.sock;
    }

    include /etc/nginx/upstreams/*.conf;

    map '' $upstream {
        default php;
    }

    # If the requested body size is more than the buffer size, the entire body is
    # written to a temporary file. Default is 8k or 16k depending on the platform.
    client_body_buffer_size 16k;

    # If a request line or header field does not fit into this buffer, then larger
    # buffers via large_client_header_buffers are allocated
    client_header_buffer_size 1k;

    # Max size of a body to allow. This affects uploads, but can be overwritten at
    # the individual site level
    client_max_body_size 1024M;

    # The maximum number and size of large headers to accept from a client
    large_client_header_buffers 4 16k;

    # Accommodate server directives that have hundred(s) of server_names, such as large multisite networks
    server_names_hash_max_size 512;
    server_names_hash_bucket_size 512;

    # Make Nginx aware of our default SSL certificates
    ssl_certificate     /etc/nginx/server-2.1.0.crt;
    ssl_certificate_key /etc/nginx/server-2.1.0.key;

    # This directory is mapped to config/nginx-config/sites in the varying vagrant
    # vagrants repository. Additional conf files for sites should be put there.
    include /etc/nginx/custom-sites/*.conf;

    # This directory is used for custom nginx files to use for services downloadable by VVV.
    include /etc/nginx/custom-utilities/*.conf;

}
